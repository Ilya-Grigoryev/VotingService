<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>main</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
    <body>
        <h3>HELLO!</h3>
        <ul>
            <li>Текущий пользователь: {{ request.user }}</li>
            <li>Текущая дата: {{ date.hour }}:{{ date.minute }}:{{ date.second }}</li>
        </ul>

        <hr>
         {% verbatim %}
        <div id="vue_app">
            {{ voting }}
            <div v-for="(vote, vote_index) in voting"> <!-- @click="route(`/api/voting/${index+1}/` -->
                <h3>Заголовок: {{ vote.title }}</h3>
                <h5>Описание: {{ vote.description }}</h5>
                <h5>Автор: {{ vote.user.name }}</h5>
                <h5>Время начала голосования: {{ vote.start_date }}</h5>
                <h5>Время конца голосования: {{ vote.end_date }}</h5>
                <h5>Статус: {{ vote.status }}</h5>
                <h5>Тип голосования: {{ vote.type }}</h5>
                <h4>Варианты ответов:</h4>
                    <div v-for="(option, option_index) in vote.options">
                        <b style="background-color: gray" @click="set_option(option.id, vote_index, option_index)">{{ option.text }}</b><br>
                        <div>Проголосовали: {{ option.users.length }} человек (<b v-for="user in option.users">{{ user.name }}, </b>)</div>
                    </div>
                <hr>
            </div>

        </div>
        {% endverbatim %}

        <script>
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            new Vue({
                el: '#vue_app',
                data: {
                    voting: [],
                    votedusers: [],
                },
                methods: {
                    route: function(href) {
                        window.location.href = href;
                    },
                     set_option: function(option_id, vote_index, option_index) {
                         console.log(option_id)
                         this.voting[vote_index].options[option_index].users.push({"name":"ilya", "id":1,})
                         axios({
                             method: 'POST',
                             url: '/api/votedusers/',
                             headers: {'X-CSRFToken': '{% csrf_token %}'.replace('<input type="hidden" name="csrfmiddlewaretoken" value="', '').replace('">', '')},
                             data: {option_id: option_id}
                         }).then((response) => {
                         console.log("POSTED! response: ", response)
                         })
                     }
                },
                created: function () {
                    axios.get('/api/voting').then((response) => {
                        this.voting = response.data;
                        for(let i = 0; i < this.voting.length; i++) {
                            this.voting[i].start_date = new Date(this.voting[i].start_date)
                            this.voting[i].end_date = new Date(this.voting[i].end_date)
                        }
                    })
                }
            })
        </script>
    </body>
</html>